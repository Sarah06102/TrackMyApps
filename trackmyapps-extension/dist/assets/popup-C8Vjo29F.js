import{l as y,m as T,d as k,a as p,h as E,n as j,G as I,p as L}from"./firebase-BZUsZNDy.js";let c=null,d=!1;function C(a){chrome.identity.getAuthToken({interactive:!1},i=>{i?chrome.identity.removeCachedAuthToken({token:i},()=>{console.log("ðŸ”„ Removed existing token"),a()}):a()})}const u=()=>{const a=y();chrome.identity.getAuthToken({interactive:!1},t=>{t?chrome.identity.removeCachedAuthToken({token:t},()=>{console.log("ðŸ”„ Removed cached Chrome token"),i()}):i()});function i(){chrome.identity.getAuthToken({interactive:!0},function(t){var o,s;if(chrome.runtime.lastError||!t){console.error("Chrome login failed:",((o=chrome.runtime.lastError)==null?void 0:o.message)||"Unknown error"),alert("Login failed: "+(((s=chrome.runtime.lastError)==null?void 0:s.message)||"No details"));return}console.log("New token retrieved:",t);const r=I.credential(null,t);L(a,r).then(n=>{console.log("Firebase login successful:",n.user),c=n.user,updateUI(n.user)}).catch(n=>{console.error("Firebase sign-in error:",n.code,n.message,n.customData)})})}};document.addEventListener("DOMContentLoaded",function(){const a=document.getElementById("save-job-btn"),i=document.getElementById("main-content"),t=document.getElementById("success-msg"),r=document.getElementById("not-logged-in"),o=document.getElementById("error-msg"),s=document.getElementById("logout-btn");function n(e){e?(console.log("User is signed in:",e.email),i.style.display="block",r.style.display="none",o.style.display="none",t.style.display="none",s&&(s.style.display="block")):(console.warn("No user signed in"),c=null,i.style.display="none",t.classList.remove("fade-in","fade-out"),t.style.display="none",o.innerText="",o.style.display="none",r.style.display="block",s&&(s.style.display="none"))}document.getElementById("chrome-login-btn").addEventListener("click",()=>{chrome.identity.getAuthToken({interactive:!0},e=>{e?chrome.identity.removeCachedAuthToken({token:e},()=>{console.log("ðŸ§¼ Cleared token before Firebase login"),u()}):u()})});const g=y();let m=!1,f=null;T(g,e=>{(e==null?void 0:e.uid)!==f&&(f=(e==null?void 0:e.uid)||null,console.log("Firebase sees this user (via onIdTokenChanged):",e),c=e,document.getElementById("loading-state").style.display="none",n(e),!e&&!m&&!d&&(m=!0,console.log("ðŸ”’ No user, forcing Google login flow..."),C(u)),e||(d=!1))}),s&&s.addEventListener("click",function(){d=!0,g.signOut().then(()=>{console.log("User signed out."),chrome.identity.getAuthToken({interactive:!1},function(e){e?chrome.identity.removeCachedAuthToken({token:e},function(){console.log("Removed cached token after logout"),c=null,n(null),setTimeout(()=>{console.log("âœ… Next login will show Google picker.")},200)}):(c=null,n(null))})}).catch(e=>{console.error("Sign-out error:",e)})}),a.addEventListener("click",function(){if(!c){o.innerText="You must be signed in to save jobs.",o.style.display="block";return}chrome.tabs.query({active:!0,currentWindow:!0},function(e){if(!e.length){console.error("No active tab found");return}chrome.tabs.sendMessage(e[0].id,{action:"getJobInfo"},function(l){if(chrome.runtime.lastError){console.error("Message error:",chrome.runtime.lastError.message),o.innerText="Cannot access tab. Try refreshing the page.",o.style.display="block";return}if(!l){o.innerText="No job info received. Try again.",o.style.display="block";return}if(console.log("Received response from content script:",l),console.log("Received job info:",l),l&&l.jobTitle&&l.companyName&&l.jobDesc){const h=k(p,"users",c.uid),b=E(h,"jobs");console.log("âœ… Saving job for user:",c.uid),j(b,{jobTitle:l.jobTitle,companyName:l.companyName,jobDesc:l.jobDesc,dateSaved:new Date().toISOString()}).then(function(){console.log("Job saved successfully!"),i.classList.add("fade-out"),i.style.display="none",t.style.display="block",t.classList.add("fade-in"),setTimeout(()=>{t.classList.remove("fade-in"),t.classList.add("fade-out")},2e3),setTimeout(()=>{window.close()},2500)}).catch(function(v){console.error("Error saving job: ",v),o.innerText="Failed to save job. Try again.",o.style.display="block"})}else o.innerText="Could not get job info. Try again.",o.style.display="block"})})})});
